{"version":3,"sources":["../../../lib/xlsx/xlsx.js"],"names":["fs","require","ZipStream","StreamBuf","utils","XmlStream","StylesXform","CoreXform","SharedStringsXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","WorksheetXform","DrawingXform","TableXform","CommentsXform","VmlNotesXform","theme1Xml","fsReadFileAsync","filename","options","Promise","resolve","reject","readFile","error","data","XLSX","workbook","exists","Error","stream","createReadStream","read","close","xform","parseStream","model","workbookXform","worksheetXform","drawingXform","tableXform","reconcile","drawingOptions","media","mediaIndex","Object","keys","drawings","forEach","name","drawing","drawingRel","drawingRels","rels","reduce","o","rel","Id","tableOptions","styles","values","tables","table","sheetOptions","sharedStrings","date1904","properties","comments","worksheets","worksheet","relationships","worksheetRels","sheetNo","worksheetHash","globalRels","workbookRels","sheetDefs","entry","path","push","lastDot","lastIndexOf","extension","substr","streamBuf","on","length","medium","type","buffer","toBuffer","pipe","themes","toString","promises","ZipReader","getEntryType","match","entryPath","parseRels","parseWorkbook","sheets","definedNames","views","calcProperties","appXform","appProperties","company","manager","coreXform","coreProperties","assign","_processWorksheetEntry","_processWorksheetRelsEntry","_processThemeEntry","_processMediaEntry","_processDrawingEntry","_processCommentEntry","_processTableEntry","_processDrawingRelsEntry","autodrain","destroy","all","emit","zipStream","createInputStream","undefined","base64","Buffer","from","write","end","zip","map","append","dataimg64","content","substring","indexOf","relsXform","prepare","xml","toXml","tableXml","target","theme1","Type","RelType","OfficeDocument","Target","CoreProperties","ExtenderProperties","count","Styles","Theme","SharedStrings","rId","Worksheet","id","relationshipsXform","commentsXform","vmlNotesXform","xmlStream","render","finalize","creator","lastModifiedBy","created","Date","modified","useSharedStrings","useStyles","Mock","worksheetOptions","drawingsCount","commentRefs","tableCount","ZipWriter","prepareModel","addContentTypes","addOfficeRels","addWorkbookRels","addWorksheets","addSharedStrings","addDrawings","addTables","addThemes","addStyles","addMedia","addApp","addCore","addWorkbook","_finalize","createWriteStream","then","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\nconst ZipStream = require('../utils/zip-stream');\nconst StreamBuf = require('../utils/stream-buf');\n\nconst utils = require('../utils/utils');\nconst XmlStream = require('../utils/xml-stream');\n\nconst StylesXform = require('./xform/style/styles-xform');\n\nconst CoreXform = require('./xform/core/core-xform');\nconst SharedStringsXform = require('./xform/strings/shared-strings-xform');\nconst RelationshipsXform = require('./xform/core/relationships-xform');\nconst ContentTypesXform = require('./xform/core/content-types-xform');\nconst AppXform = require('./xform/core/app-xform');\nconst WorkbookXform = require('./xform/book/workbook-xform');\nconst WorksheetXform = require('./xform/sheet/worksheet-xform');\nconst DrawingXform = require('./xform/drawing/drawing-xform');\nconst TableXform = require('./xform/table/table-xform');\nconst CommentsXform = require('./xform/comment/comments-xform');\nconst VmlNotesXform = require('./xform/comment/vml-notes-xform');\n\nconst theme1Xml = require('./xml/theme1.js');\n\nfunction fsReadFileAsync(filename, options) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(filename, options, (error, data) => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve(data);\n      }\n    });\n  });\n}\n\nclass XLSX {\n  constructor(workbook) {\n    this.workbook = workbook;\n  }\n\n  // ===============================================================================\n  // Workbook\n  // =========================================================================\n  // Read\n\n  async readFile(filename, options) {\n    if (!(await utils.fs.exists(filename))) {\n      throw new Error(`File not found: ${filename}`);\n    }\n    const stream = fs.createReadStream(filename);\n    try {\n      const workbook = await this.read(stream, options);\n      stream.close();\n      return workbook;\n    } catch (error) {\n      stream.close();\n      throw error;\n    }\n  }\n\n  parseRels(stream) {\n    const xform = new RelationshipsXform();\n    return xform.parseStream(stream);\n  }\n\n  parseWorkbook(stream) {\n    const xform = new WorkbookXform();\n    return xform.parseStream(stream);\n  }\n\n  parseSharedStrings(stream) {\n    const xform = new SharedStringsXform();\n    return xform.parseStream(stream);\n  }\n\n  reconcile(model, options) {\n    const workbookXform = new WorkbookXform();\n    const worksheetXform = new WorksheetXform(options);\n    const drawingXform = new DrawingXform();\n    const tableXform = new TableXform();\n\n    workbookXform.reconcile(model);\n\n    // reconcile drawings with their rels\n    const drawingOptions = {\n      media: model.media,\n      mediaIndex: model.mediaIndex,\n    };\n    Object.keys(model.drawings).forEach(name => {\n      const drawing = model.drawings[name];\n      const drawingRel = model.drawingRels[name];\n      if (drawingRel) {\n        drawingOptions.rels = drawingRel.reduce((o, rel) => {\n          o[rel.Id] = rel;\n          return o;\n        }, {});\n        drawingXform.reconcile(drawing, drawingOptions);\n      }\n    });\n\n    // reconcile tables with the default styles\n    const tableOptions = {\n      styles: model.styles,\n    };\n    Object.values(model.tables).forEach(table => {\n      tableXform.reconcile(table, tableOptions);\n    });\n\n    const sheetOptions = {\n      styles: model.styles,\n      sharedStrings: model.sharedStrings,\n      media: model.media,\n      mediaIndex: model.mediaIndex,\n      date1904: model.properties && model.properties.date1904,\n      drawings: model.drawings,\n      comments: model.comments,\n      tables: model.tables,\n    };\n    model.worksheets.forEach(worksheet => {\n      worksheet.relationships = model.worksheetRels[worksheet.sheetNo];\n      worksheetXform.reconcile(worksheet, sheetOptions);\n    });\n\n    // delete unnecessary parts\n    delete model.worksheetHash;\n    delete model.worksheetRels;\n    delete model.globalRels;\n    delete model.sharedStrings;\n    delete model.workbookRels;\n    delete model.sheetDefs;\n    delete model.styles;\n    delete model.mediaIndex;\n    delete model.drawings;\n    delete model.drawingRels;\n  }\n\n  async _processWorksheetEntry(entry, model, sheetNo, options) {\n    const xform = new WorksheetXform(options);\n    const worksheet = await xform.parseStream(entry);\n    worksheet.sheetNo = sheetNo;\n    model.worksheetHash[entry.path] = worksheet;\n    model.worksheets.push(worksheet);\n  }\n\n  async _processCommentEntry(entry, model, name) {\n    const xform = new CommentsXform();\n    const comments = await xform.parseStream(entry);\n    model.comments[`../${name}.xml`] = comments;\n  }\n\n  async _processTableEntry(entry, model, name) {\n    const xform = new TableXform();\n    const table = await xform.parseStream(entry);\n    model.tables[`../tables/${name}.xml`] = table;\n  }\n\n  async _processWorksheetRelsEntry(entry, model, sheetNo) {\n    const xform = new RelationshipsXform();\n    const relationships = await xform.parseStream(entry);\n    model.worksheetRels[sheetNo] = relationships;\n  }\n\n  async _processMediaEntry(entry, model, filename) {\n    const lastDot = filename.lastIndexOf('.');\n    // if we can't determine extension, ignore it\n    if (lastDot >= 1) {\n      const extension = filename.substr(lastDot + 1);\n      const name = filename.substr(0, lastDot);\n      await new Promise((resolve, reject) => {\n        const streamBuf = new StreamBuf();\n        streamBuf.on('finish', () => {\n          model.mediaIndex[filename] = model.media.length;\n          model.mediaIndex[name] = model.media.length;\n          const medium = {\n            type: 'image',\n            name,\n            extension,\n            buffer: streamBuf.toBuffer(),\n          };\n          model.media.push(medium);\n          resolve();\n        });\n        entry.on('error', error => {\n          reject(error);\n        });\n        entry.pipe(streamBuf);\n      });\n    }\n  }\n\n  async _processDrawingEntry(entry, model, name) {\n    const xform = new DrawingXform();\n    const drawing = await xform.parseStream(entry);\n    model.drawings[name] = drawing;\n  }\n\n  async _processDrawingRelsEntry(entry, model, name) {\n    const xform = new RelationshipsXform();\n    const relationships = await xform.parseStream(entry);\n    model.drawingRels[name] = relationships;\n  }\n\n  async _processThemeEntry(entry, model, name) {\n    await new Promise((resolve, reject) => {\n      // TODO: stream entry into buffer and store the xml in the model.themes[]\n      const stream = new StreamBuf();\n      entry.on('error', reject);\n      stream.on('error', reject);\n      stream.on('finish', () => {\n        model.themes[name] = stream.read().toString();\n        resolve();\n      });\n      entry.pipe(stream);\n    });\n  }\n\n  createInputStream(options) {\n    const model = {\n      worksheets: [],\n      worksheetHash: {},\n      worksheetRels: [],\n      themes: {},\n      media: [],\n      mediaIndex: {},\n      drawings: {},\n      drawingRels: {},\n      comments: {},\n      tables: {},\n    };\n\n    // we have to be prepared to read the zip entries in whatever order they arrive\n    const promises = [];\n    const stream = new ZipStream.ZipReader({\n      getEntryType: path => (path.match(/xl\\/media\\//) ? 'nodebuffer' : 'string'),\n    });\n    stream.on('entry', entry => {\n      promises.push(\n        (async () => {\n          try {\n            let entryPath = entry.path;\n            if (entryPath[0] === '/') {\n              entryPath = entryPath.substr(1);\n            }\n            switch (entryPath) {\n              case '_rels/.rels':\n                model.globalRels = await this.parseRels(entry);\n                break;\n\n              case 'xl/workbook.xml': {\n                const workbook = await this.parseWorkbook(entry);\n                model.sheets = workbook.sheets;\n                model.definedNames = workbook.definedNames;\n                model.views = workbook.views;\n                model.properties = workbook.properties;\n                model.calcProperties = workbook.calcProperties;\n                break;\n              }\n\n              case 'xl/_rels/workbook.xml.rels':\n                model.workbookRels = await this.parseRels(entry);\n                break;\n\n              case 'xl/sharedStrings.xml':\n                model.sharedStrings = new SharedStringsXform();\n                await model.sharedStrings.parseStream(entry);\n                break;\n\n              case 'xl/styles.xml':\n                model.styles = new StylesXform();\n                await model.styles.parseStream(entry);\n                break;\n\n              case 'docProps/app.xml': {\n                const appXform = new AppXform();\n                const appProperties = await appXform.parseStream(entry);\n                model.company = appProperties.company;\n                model.manager = appProperties.manager;\n                break;\n              }\n\n              case 'docProps/core.xml': {\n                const coreXform = new CoreXform();\n                const coreProperties = await coreXform.parseStream(entry);\n                Object.assign(model, coreProperties);\n                break;\n              }\n\n              default: {\n                let match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\n                if (match) {\n                  await this._processWorksheetEntry(entry, model, match[1], options);\n                  break;\n                }\n                match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\n                if (match) {\n                  await this._processWorksheetRelsEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/theme\\/([a-zA-Z0-9]+)[.]xml/);\n                if (match) {\n                  await this._processThemeEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/media\\/([a-zA-Z0-9]+[.][a-zA-Z0-9]{3,4})$/);\n                if (match) {\n                  await this._processMediaEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/drawings\\/([a-zA-Z0-9]+)[.]xml/);\n                if (match) {\n                  await this._processDrawingEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/(comments\\d+)[.]xml/);\n                if (match) {\n                  await this._processCommentEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/tables\\/(table\\d+)[.]xml/);\n                if (match) {\n                  await this._processTableEntry(entry, model, match[1]);\n                  break;\n                }\n                match = entry.path.match(/xl\\/drawings\\/_rels\\/([a-zA-Z0-9]+)[.]xml[.]rels/);\n                if (match) {\n                  await this._processDrawingRelsEntry(entry, model, match[1]);\n                  break;\n                }\n\n                entry.autodrain();\n              }\n            }\n          } catch (error) {\n            stream.destroy(error);\n            throw error;\n          }\n        })()\n      );\n    });\n    stream.on('finished', async () => {\n      try {\n        await Promise.all(promises);\n        this.reconcile(model, options);\n\n        // apply model\n        this.workbook.model = model;\n        stream.emit('done');\n      } catch (error) {\n        stream.emit('error', error);\n      }\n    });\n    return stream;\n  }\n\n  read(stream, options) {\n    return new Promise((resolve, reject) => {\n      options = options || {};\n      const zipStream = this.createInputStream(options);\n      zipStream\n        .on('done', () => {\n          resolve(this.workbook);\n        })\n        .on('error', error => {\n          reject(error);\n        });\n      stream.pipe(zipStream);\n    });\n  }\n\n  load(data, options) {\n    if (options === undefined) {\n      options = {};\n    }\n    const zipStream = this.createInputStream();\n    return new Promise((resolve, reject) => {\n      zipStream\n        .on('done', () => {\n          resolve(this.workbook);\n        })\n        .on('error', error => {\n          reject(error);\n        });\n\n      if (options.base64) {\n        const buffer = Buffer.from(data.toString(), 'base64');\n        zipStream.write(buffer);\n      } else {\n        zipStream.write(data);\n      }\n      zipStream.end();\n    });\n  }\n\n  // =========================================================================\n  // Write\n\n  async addMedia(zip, model) {\n    await Promise.all(\n      model.media.map(async medium => {\n        if (medium.type === 'image') {\n          const filename = `xl/media/${medium.name}.${medium.extension}`;\n          if (medium.filename) {\n            const data = await fsReadFileAsync(medium.filename);\n            return zip.append(data, {name: filename});\n          }\n          if (medium.buffer) {\n            return zip.append(medium.buffer, {name: filename});\n          }\n          if (medium.base64) {\n            const dataimg64 = medium.base64;\n            const content = dataimg64.substring(dataimg64.indexOf(',') + 1);\n            return zip.append(content, {name: filename, base64: true});\n          }\n        }\n        throw new Error('Unsupported media');\n      })\n    );\n  }\n\n  addDrawings(zip, model) {\n    const drawingXform = new DrawingXform();\n    const relsXform = new RelationshipsXform();\n\n    model.worksheets.forEach(worksheet => {\n      const {drawing} = worksheet;\n      if (drawing) {\n        drawingXform.prepare(drawing, {});\n        let xml = drawingXform.toXml(drawing);\n        zip.append(xml, {name: `xl/drawings/${drawing.name}.xml`});\n\n        xml = relsXform.toXml(drawing.rels);\n        zip.append(xml, {name: `xl/drawings/_rels/${drawing.name}.xml.rels`});\n      }\n    });\n  }\n\n  addTables(zip, model) {\n    const tableXform = new TableXform();\n\n    model.worksheets.forEach(worksheet => {\n      const {tables} = worksheet;\n      tables.forEach(table => {\n        tableXform.prepare(table, {});\n        const tableXml = tableXform.toXml(table);\n        zip.append(tableXml, {name: `xl/tables/${table.target}`});\n      });\n    });\n  }\n\n  async addContentTypes(zip, model) {\n    const xform = new ContentTypesXform();\n    const xml = xform.toXml(model);\n    zip.append(xml, {name: '[Content_Types].xml'});\n  }\n\n  async addApp(zip, model) {\n    const xform = new AppXform();\n    const xml = xform.toXml(model);\n    zip.append(xml, {name: 'docProps/app.xml'});\n  }\n\n  async addCore(zip, model) {\n    const coreXform = new CoreXform();\n    zip.append(coreXform.toXml(model), {name: 'docProps/core.xml'});\n  }\n\n  async addThemes(zip, model) {\n    const themes = model.themes || {theme1: theme1Xml};\n    Object.keys(themes).forEach(name => {\n      const xml = themes[name];\n      const path = `xl/theme/${name}.xml`;\n      zip.append(xml, {name: path});\n    });\n  }\n\n  async addOfficeRels(zip) {\n    const xform = new RelationshipsXform();\n    const xml = xform.toXml([\n      {Id: 'rId1', Type: XLSX.RelType.OfficeDocument, Target: 'xl/workbook.xml'},\n      {Id: 'rId2', Type: XLSX.RelType.CoreProperties, Target: 'docProps/core.xml'},\n      {Id: 'rId3', Type: XLSX.RelType.ExtenderProperties, Target: 'docProps/app.xml'},\n    ]);\n    zip.append(xml, {name: '_rels/.rels'});\n  }\n\n  async addWorkbookRels(zip, model) {\n    let count = 1;\n    const relationships = [\n      {Id: `rId${count++}`, Type: XLSX.RelType.Styles, Target: 'styles.xml'},\n      {Id: `rId${count++}`, Type: XLSX.RelType.Theme, Target: 'theme/theme1.xml'},\n    ];\n    if (model.sharedStrings.count) {\n      relationships.push({Id: `rId${count++}`, Type: XLSX.RelType.SharedStrings, Target: 'sharedStrings.xml'});\n    }\n    model.worksheets.forEach(worksheet => {\n      worksheet.rId = `rId${count++}`;\n      relationships.push({Id: worksheet.rId, Type: XLSX.RelType.Worksheet, Target: `worksheets/sheet${worksheet.id}.xml`});\n    });\n    const xform = new RelationshipsXform();\n    const xml = xform.toXml(relationships);\n    zip.append(xml, {name: 'xl/_rels/workbook.xml.rels'});\n  }\n\n  async addSharedStrings(zip, model) {\n    if (model.sharedStrings && model.sharedStrings.count) {\n      zip.append(model.sharedStrings.xml, {name: 'xl/sharedStrings.xml'});\n    }\n  }\n\n  async addStyles(zip, model) {\n    const {xml} = model.styles;\n    if (xml) {\n      zip.append(xml, {name: 'xl/styles.xml'});\n    }\n  }\n\n  async addWorkbook(zip, model) {\n    const xform = new WorkbookXform();\n    zip.append(xform.toXml(model), {name: 'xl/workbook.xml'});\n  }\n\n  async addWorksheets(zip, model) {\n    // preparation phase\n    const worksheetXform = new WorksheetXform();\n    const relationshipsXform = new RelationshipsXform();\n    const commentsXform = new CommentsXform();\n    const vmlNotesXform = new VmlNotesXform();\n\n    // write sheets\n    model.worksheets.forEach(worksheet => {\n      let xmlStream = new XmlStream();\n      worksheetXform.render(xmlStream, worksheet);\n      zip.append(xmlStream.xml, {name: `xl/worksheets/sheet${worksheet.id}.xml`});\n\n      if (worksheet.rels && worksheet.rels.length) {\n        xmlStream = new XmlStream();\n        relationshipsXform.render(xmlStream, worksheet.rels);\n        zip.append(xmlStream.xml, {name: `xl/worksheets/_rels/sheet${worksheet.id}.xml.rels`});\n      }\n\n      if (worksheet.comments.length > 0) {\n        xmlStream = new XmlStream();\n        commentsXform.render(xmlStream, worksheet);\n        zip.append(xmlStream.xml, {name: `xl/comments${worksheet.id}.xml`});\n\n        xmlStream = new XmlStream();\n        vmlNotesXform.render(xmlStream, worksheet);\n        zip.append(xmlStream.xml, {name: `xl/drawings/vmlDrawing${worksheet.id}.vml`});\n      }\n    });\n  }\n\n  _finalize(zip) {\n    return new Promise((resolve, reject) => {\n      zip.on('finish', () => {\n        resolve(this);\n      });\n      zip.on('error', reject);\n      zip.finalize();\n    });\n  }\n\n  prepareModel(model, options) {\n    // ensure following properties have sane values\n    model.creator = model.creator || 'ExcelJS';\n    model.lastModifiedBy = model.lastModifiedBy || 'ExcelJS';\n    model.created = model.created || new Date();\n    model.modified = model.modified || new Date();\n\n    model.useSharedStrings = options.useSharedStrings !== undefined ? options.useSharedStrings : true;\n    model.useStyles = options.useStyles !== undefined ? options.useStyles : true;\n\n    // Manage the shared strings\n    model.sharedStrings = new SharedStringsXform();\n\n    // add a style manager to handle cell formats, fonts, etc.\n    model.styles = model.useStyles ? new StylesXform(true) : new StylesXform.Mock();\n\n    // prepare all of the things before the render\n    const workbookXform = new WorkbookXform();\n    const worksheetXform = new WorksheetXform();\n\n    workbookXform.prepare(model);\n\n    const worksheetOptions = {\n      sharedStrings: model.sharedStrings,\n      styles: model.styles,\n      date1904: model.properties.date1904,\n      drawingsCount: 0,\n      media: model.media,\n    };\n    worksheetOptions.drawings = model.drawings = [];\n    worksheetOptions.commentRefs = model.commentRefs = [];\n    let tableCount = 0;\n    model.tables = [];\n    model.worksheets.forEach(worksheet => {\n      // assign unique filenames to tables\n      worksheet.tables.forEach(table => {\n        tableCount++;\n        table.target = `table${tableCount}.xml`;\n        table.id = tableCount;\n        model.tables.push(table);\n      });\n\n      worksheetXform.prepare(worksheet, worksheetOptions);\n    });\n\n    // TODO: workbook drawing list\n  }\n\n  async write(stream, options) {\n    options = options || {};\n    const {model} = this.workbook;\n    const zip = new ZipStream.ZipWriter(options.zip);\n    zip.pipe(stream);\n\n    this.prepareModel(model, options);\n\n    // render\n    await this.addContentTypes(zip, model);\n    await this.addOfficeRels(zip, model);\n    await this.addWorkbookRels(zip, model);\n    await this.addWorksheets(zip, model);\n    await this.addSharedStrings(zip, model); // always after worksheets\n    await this.addDrawings(zip, model);\n    await this.addTables(zip, model);\n    await Promise.all([this.addThemes(zip, model), this.addStyles(zip, model)]);\n    await this.addMedia(zip, model);\n    await Promise.all([this.addApp(zip, model), this.addCore(zip, model)]);\n    await this.addWorkbook(zip, model);\n    return this._finalize(zip);\n  }\n\n  writeFile(filename, options) {\n    const stream = fs.createWriteStream(filename);\n\n    return new Promise((resolve, reject) => {\n      stream.on('finish', () => {\n        resolve();\n      });\n      stream.on('error', error => {\n        reject(error);\n      });\n\n      this.write(stream, options)\n        .then(() => {\n          stream.end();\n        });\n    });\n  }\n\n  async writeBuffer(options) {\n    const stream = new StreamBuf();\n    await this.write(stream, options);\n    return stream.read();\n  }\n}\n\nXLSX.RelType = require('./rel-type');\n\nmodule.exports = XLSX;\n"],"file":"xlsx.js"}